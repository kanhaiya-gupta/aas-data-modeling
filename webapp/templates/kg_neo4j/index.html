{% extends "base.html" %}

{% block title %}Knowledge Graph - Neo4j{% endblock %}

{% block extra_css %}
<!-- D3.js for graph visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Additional Neo4j styles -->
<link href="{{ url_for('static', path='/css/kg_neo4j.css') }}" rel="stylesheet">
<!-- Neo4j Browser CSS for Cypher query styling -->
<style>
    .cypher-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        background-color: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        min-height: 200px;
    }
    
    .graph-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .node {
        cursor: pointer;
        stroke: #fff;
        stroke-width: 2px;
    }
    
    .link {
        stroke: #999;
        stroke-opacity: 0.6;
        stroke-width: 2px;
    }
    
    .node-label {
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        fill: #333;
    }
    
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
    }
    
    .query-result {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 10px 0;
        border-radius: 0 8px 8px 0;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-connected { background-color: #28a745; }
    .status-disconnected { background-color: #dc3545; }
    .status-connecting { background-color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="fas fa-project-diagram text-primary me-2"></i>
                        Knowledge Graph - Neo4j
                    </h1>
                    <p class="text-muted mb-0">Interactive AASX Data Graph Explorer</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-connected" id="connectionStatus"></span>
                    <span class="me-3" id="connectionText">Connected</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshConnection()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0" id="nodeCount">-</h3>
                        <p class="mb-0">Total Nodes</p>
                    </div>
                    <i class="fas fa-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0" id="relationshipCount">-</h3>
                        <p class="mb-0">Relationships</p>
                    </div>
                    <i class="fas fa-link fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0" id="assetCount">-</h3>
                        <p class="mb-0">Assets</p>
                    </div>
                    <i class="fas fa-cube fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3 class="mb-0" id="submodelCount">-</h3>
                        <p class="mb-0">Submodels</p>
                    </div>
                    <i class="fas fa-layer-group fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="kgTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button" role="tab">
                        <i class="fas fa-project-diagram me-1"></i>Graph Visualization
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button" role="tab">
                        <i class="fas fa-search me-1"></i>Cypher Queries
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-line me-1"></i>Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab">
                        <i class="fas fa-upload me-1"></i>Import Data
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="kgTabContent">
                <!-- Graph Visualization Tab -->
                <div class="tab-pane fade show active" id="graph" role="tabpanel">
                    <div class="graph-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Interactive Graph</h4>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="loadGraphData()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetZoom()">
                                    <i class="fas fa-expand-arrows-alt me-1"></i>Reset View
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="exportGraph()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <div id="graphVisualization" style="height: 600px; border: 1px solid #dee2e6; border-radius: 8px;"></div>
                    </div>
                </div>

                <!-- Cypher Queries Tab -->
                <div class="tab-pane fade" id="query" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-code me-1"></i>Cypher Query Editor
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <textarea id="cypherQuery" class="cypher-editor w-100" placeholder="Enter your Cypher query here...">MATCH (n) RETURN n LIMIT 10</textarea>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="executeQuery()">
                                            <i class="fas fa-play me-1"></i>Execute Query
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="clearQuery()">
                                            <i class="fas fa-eraser me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pre-built Queries -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Pre-built Queries</h6>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        <button class="list-group-item list-group-item-action" onclick="loadQuery('basic-stats')">
                                            <i class="fas fa-chart-bar me-1"></i>Basic Statistics
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="loadQuery('quality-distribution')">
                                            <i class="fas fa-star me-1"></i>Quality Distribution
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="loadQuery('compliance-summary')">
                                            <i class="fas fa-check-circle me-1"></i>Compliance Summary
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="loadQuery('isolated-nodes')">
                                            <i class="fas fa-unlink me-1"></i>Isolated Nodes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-table me-1"></i>Query Results
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="queryResults" class="query-result">
                                        <p class="text-muted">Execute a query to see results here...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-1"></i>Quality Distribution
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="qualityChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-bar me-1"></i>Entity Types
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="entityChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-list me-1"></i>Detailed Analytics
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="analyticsResults">
                                        <p class="text-muted">Loading analytics...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Tab -->
                <div class="tab-pane fade" id="import" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-upload me-1"></i>Import Graph Data
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="importForm">
                                        <div class="mb-3">
                                            <label for="importDirectory" class="form-label">ETL Output Directory</label>
                                            <input type="text" class="form-control" id="importDirectory" value="output/etl_results" placeholder="Path to ETL output directory">
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="clearDatabase" checked>
                                                <label class="form-check-label" for="clearDatabase">
                                                    Clear existing data before import
                                                </label>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload me-1"></i>Import Data
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-1"></i>Import Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="importStatus">
                                        <p class="text-muted">Ready to import data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom Neo4j JS -->
<script src="{{ url_for('static', path='/js/kg_neo4j.js') }}"></script>
{% endblock %} 